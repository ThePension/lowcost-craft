var he=Object.defineProperty;var pe=(e,t,r)=>t in e?he(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var v=(e,t,r)=>pe(e,typeof t!="symbol"?t+"":t,r);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function r(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(n){if(n.ep)return;n.ep=!0;const s=r(n);fetch(n.href,s)}})();var _=1e-6,R=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});function D(){var e=new R(16);return R!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function ue(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function me(e,t,r){var i=t[0],n=t[1],s=t[2],a=t[3],o=t[4],l=t[5],x=t[6],f=t[7],d=t[8],g=t[9],c=t[10],M=t[11],y=t[12],w=t[13],P=t[14],S=t[15],h=r[0],p=r[1],u=r[2],m=r[3];return e[0]=h*i+p*o+u*d+m*y,e[1]=h*n+p*l+u*g+m*w,e[2]=h*s+p*x+u*c+m*P,e[3]=h*a+p*f+u*M+m*S,h=r[4],p=r[5],u=r[6],m=r[7],e[4]=h*i+p*o+u*d+m*y,e[5]=h*n+p*l+u*g+m*w,e[6]=h*s+p*x+u*c+m*P,e[7]=h*a+p*f+u*M+m*S,h=r[8],p=r[9],u=r[10],m=r[11],e[8]=h*i+p*o+u*d+m*y,e[9]=h*n+p*l+u*g+m*w,e[10]=h*s+p*x+u*c+m*P,e[11]=h*a+p*f+u*M+m*S,h=r[12],p=r[13],u=r[14],m=r[15],e[12]=h*i+p*o+u*d+m*y,e[13]=h*n+p*l+u*g+m*w,e[14]=h*s+p*x+u*c+m*P,e[15]=h*a+p*f+u*M+m*S,e}function se(e,t,r){var i=r[0],n=r[1],s=r[2],a,o,l,x,f,d,g,c,M,y,w,P;return t===e?(e[12]=t[0]*i+t[4]*n+t[8]*s+t[12],e[13]=t[1]*i+t[5]*n+t[9]*s+t[13],e[14]=t[2]*i+t[6]*n+t[10]*s+t[14],e[15]=t[3]*i+t[7]*n+t[11]*s+t[15]):(a=t[0],o=t[1],l=t[2],x=t[3],f=t[4],d=t[5],g=t[6],c=t[7],M=t[8],y=t[9],w=t[10],P=t[11],e[0]=a,e[1]=o,e[2]=l,e[3]=x,e[4]=f,e[5]=d,e[6]=g,e[7]=c,e[8]=M,e[9]=y,e[10]=w,e[11]=P,e[12]=a*i+f*n+M*s+t[12],e[13]=o*i+d*n+y*s+t[13],e[14]=l*i+g*n+w*s+t[14],e[15]=x*i+c*n+P*s+t[15]),e}function ye(e,t,r){var i=r[0],n=r[1],s=r[2];return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*s,e[9]=t[9]*s,e[10]=t[10]*s,e[11]=t[11]*s,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function ge(e,t,r,i,n){var s=1/Math.tan(t/2),a;return e[0]=s/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,n!=null&&n!==1/0?(a=1/(i-n),e[10]=(n+i)*a,e[14]=2*n*i*a):(e[10]=-1,e[14]=-2*i),e}var we=ge;function xe(e,t,r,i){var n,s,a,o,l,x,f,d,g,c,M=t[0],y=t[1],w=t[2],P=i[0],S=i[1],h=i[2],p=r[0],u=r[1],m=r[2];return Math.abs(M-p)<_&&Math.abs(y-u)<_&&Math.abs(w-m)<_?ue(e):(f=M-p,d=y-u,g=w-m,c=1/Math.hypot(f,d,g),f*=c,d*=c,g*=c,n=S*g-h*d,s=h*f-P*g,a=P*d-S*f,c=Math.hypot(n,s,a),c?(c=1/c,n*=c,s*=c,a*=c):(n=0,s=0,a=0),o=d*a-g*s,l=g*n-f*a,x=f*s-d*n,c=Math.hypot(o,l,x),c?(c=1/c,o*=c,l*=c,x*=c):(o=0,l=0,x=0),e[0]=n,e[1]=o,e[2]=f,e[3]=0,e[4]=s,e[5]=l,e[6]=d,e[7]=0,e[8]=a,e[9]=x,e[10]=g,e[11]=0,e[12]=-(n*M+s*y+a*w),e[13]=-(o*M+l*y+x*w),e[14]=-(f*M+d*y+g*w),e[15]=1,e)}function H(){var e=new R(3);return R!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function Me(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e}function E(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e}function ee(e,t){var r=t[0],i=t[1],n=t[2],s=r*r+i*i+n*n;return s>0&&(s=1/Math.sqrt(s)),e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e}function Pe(e,t,r){var i=t[0],n=t[1],s=t[2],a=r[0],o=r[1],l=r[2];return e[0]=n*l-s*o,e[1]=s*a-i*l,e[2]=i*o-n*a,e}(function(){var e=H();return function(t,r,i,n,s,a){var o,l;for(r||(r=3),i||(i=0),n?l=Math.min(n*r+i,t.length):l=t.length,o=i;o<l;o+=r)e[0]=t[o],e[1]=t[o+1],e[2]=t[o+2],s(e,e,a),t[o]=e[0],t[o+1]=e[1],t[o+2]=e[2];return t}})();class T{constructor(t,r,i){v(this,"position");v(this,"modelMatrix");v(this,"textureCoords");this.position=t,this.modelMatrix=D(),se(this.modelMatrix,this.modelMatrix,t),ye(this.modelMatrix,this.modelMatrix,r),this.textureCoords=i}}v(T,"cubeVertices",new Float32Array([-.5,-.5,.5,0,1,0,0,1,.5,-.5,.5,1,1,0,0,1,.5,.5,.5,1,0,0,0,1,-.5,.5,.5,0,0,0,0,1,-.5,-.5,-.5,0,1,0,0,-1,.5,-.5,-.5,1,1,0,0,-1,.5,.5,-.5,1,0,0,0,-1,-.5,.5,-.5,0,0,0,0,-1,-.5,.5,.5,-2,0,0,1,0,.5,.5,.5,-1,0,0,1,0,.5,.5,-.5,-1,1,0,1,0,-.5,.5,-.5,-2,1,0,1,0,-.5,-.5,.5,0,1,0,-1,0,.5,-.5,.5,1,1,0,-1,0,.5,-.5,-.5,1,0,0,-1,0,-.5,-.5,-.5,0,0,0,-1,0,.5,-.5,.5,0,1,1,0,0,.5,-.5,-.5,1,1,1,0,0,.5,.5,-.5,1,0,1,0,0,.5,.5,.5,0,0,1,0,0,-.5,-.5,.5,1,1,-1,0,0,-.5,-.5,-.5,0,1,-1,0,0,-.5,.5,-.5,0,0,-1,0,0,-.5,.5,.5,1,0,-1,0,0])),v(T,"cubeIndices",new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]));class ve{constructor(){v(this,"position");v(this,"direction");v(this,"target");v(this,"up");v(this,"cameraSpeed",.5);v(this,"yaw",0);v(this,"pitch",0);v(this,"sensitivity",.002);v(this,"keysPressed",{});this.position=[0,0,0],this.direction=[0,0,0],this.target=[0,0,0],this.up=[0,1,0],window.addEventListener("keydown",t=>{this.keysPressed[t.key]=!0}),window.addEventListener("keyup",t=>{this.keysPressed[t.key]=!1}),document.addEventListener("click",()=>{document.body.requestPointerLock()}),window.addEventListener("mousemove",t=>this.hanbleMouseMoveEvent(t))}hanbleMouseMoveEvent(t){document.pointerLockElement===document.body&&(this.yaw+=t.movementX*this.sensitivity,this.pitch-=t.movementY*this.sensitivity,this.pitch=Math.max(-Math.PI/2,Math.min(Math.PI/2,this.pitch)))}updateCameraDirection(){this.direction=[Math.cos(this.pitch)*Math.cos(this.yaw),Math.sin(this.pitch),Math.cos(this.pitch)*Math.sin(this.yaw)],Me(this.target,this.position,this.direction)}updateCameraPosition(){const t=H(),r=H(),i=[0,1,0];ee(t,this.direction),Pe(r,t,i),ee(r,r),this.keysPressed.w&&E(this.position,this.position,t,this.cameraSpeed),this.keysPressed.s&&E(this.position,this.position,t,-this.cameraSpeed),this.keysPressed.a&&E(this.position,this.position,r,-this.cameraSpeed),this.keysPressed.d&&E(this.position,this.position,r,this.cameraSpeed),this.keysPressed[" "]&&E(this.position,this.position,i,this.cameraSpeed),this.keysPressed.Shift&&E(this.position,this.position,i,-this.cameraSpeed)}}class j{static async loadShaderModuleFromFile(t,r){const n=await(await fetch(r)).text();return t.createShaderModule({code:n})}static async loadAtlasTexture(t,r){const i=await fetch(r),n=await createImageBitmap(await i.blob()),s=t.createTexture({size:[n.width,n.height,1],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});return t.queue.copyExternalImageToTexture({source:n},{texture:s},[n.width,n.height]),s}}const ae=Math.sqrt(3),Se=.5*(ae-1),C=(3-ae)/6,te=e=>Math.floor(e)|0,re=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);function be(e=Math.random){const t=Be(e),r=new Float64Array(t).map(n=>re[n%12*2]),i=new Float64Array(t).map(n=>re[n%12*2+1]);return function(s,a){let o=0,l=0,x=0;const f=(s+a)*Se,d=te(s+f),g=te(a+f),c=(d+g)*C,M=d-c,y=g-c,w=s-M,P=a-y;let S,h;w>P?(S=1,h=0):(S=0,h=1);const p=w-S+C,u=P-h+C,m=w-1+2*C,N=P-1+2*C,k=d&255,V=g&255;let U=.5-w*w-P*P;if(U>=0){const b=k+t[V],L=r[b],z=i[b];U*=U,o=U*U*(L*w+z*P)}let A=.5-p*p-u*u;if(A>=0){const b=k+S+t[V+h],L=r[b],z=i[b];A*=A,l=A*A*(L*p+z*u)}let F=.5-m*m-N*N;if(F>=0){const b=k+1+t[V+1],L=r[b],z=i[b];F*=F,x=F*F*(L*m+z*N)}return 70*(o+l+x)}}function Be(e){const r=new Uint8Array(512);for(let i=0;i<512/2;i++)r[i]=i;for(let i=0;i<512/2-1;i++){const n=i+~~(e()*(256-i)),s=r[i];r[i]=r[n],r[n]=s}for(let i=256;i<512;i++)r[i]=r[i-256];return r}const Ge=be(),O=new ve,Te=16*4;let J,Z,W,$,oe,K,ce,Q,le,ie,B=[],q,fe,de;const I=200,Y=-10,Ee=20,ne=.01;for(let e=0;e<I;e++)for(let t=0;t<I;t++){let r=e-I/2,i=t-I/2,n=Ge(r*ne,i*ne)*Ee;n=Math.floor(n);for(let s=Y;s<=n;s++){const a=[r,s,i];let o;s===n?o=[4,4]:s>n-3?o=[2,0]:o=[1,0],B.push(new T(a,[1,1,1],o))}n<Y&&B.push(new T([r,Y,i],[1,1,1],[2,0]))}function Ue(e){q=new Float32Array(B.length*(4*4+2+2)),J=e.createBuffer({size:Te,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),W=e.createBuffer({size:T.cubeVertices.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});for(let t=0;t<B.length;t++){const r=D();se(r,r,B[t].position),q.set(B[t].modelMatrix,t*(4*4+2+2)),q.set(B[t].textureCoords,t*(4*4+2+2)+4*4)}Z=e.createBuffer({size:q.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST})}function Ae(e){$=e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform"}}]}),oe=e.createBindGroup({layout:$,entries:[{binding:0,resource:{buffer:J}}]}),K=e.createBindGroupLayout({entries:[{binding:1,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}}]}),ce=e.createBindGroup({layout:K,entries:[{binding:1,resource:{buffer:Z}}]}),Q=e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),le=e.createBindGroup({layout:Q,entries:[{binding:0,resource:fe.createView()},{binding:1,resource:de}]})}async function Fe(e,t){Ue(e),fe=await j.loadAtlasTexture(e,"basic_atlas.png"),de=e.createSampler({magFilter:"linear",minFilter:"linear"}),Ae(e),ie=e.createTexture({size:[G.width,G.height],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT});const r=D();we(r,Math.PI/4,G.width/G.height,.1,100),e.queue.writeBuffer(Z,0,q),e.queue.writeBuffer(W,0,T.cubeVertices);const i=e.createBuffer({size:T.cubeIndices.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST});e.queue.writeBuffer(i,0,T.cubeIndices);const n=await j.loadShaderModuleFromFile(e,"shaders/vertex.wgsl"),s=await j.loadShaderModuleFromFile(e,"shaders/fragment.wgsl");function a(){const f=D();xe(f,O.position,O.target,O.up);const d=D();me(d,r,f),e.queue.writeBuffer(J,0,d)}const o=e.createRenderPipeline({layout:e.createPipelineLayout({bindGroupLayouts:[$,K,Q]}),vertex:{module:n,entryPoint:"vertexMain",buffers:[{arrayStride:8*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x2"},{shaderLocation:2,offset:5*4,format:"float32x3"}]}]},fragment:{module:s,entryPoint:"fragmentMain",targets:[{format:navigator.gpu.getPreferredCanvasFormat()}]},primitive:{topology:"triangle-list",cullMode:"none"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}});let l=0;function x(){O.updateCameraPosition(),O.updateCameraDirection(),a();const f=performance.now()/1e3,d=f-l;l=f;const g=performance.now(),c=e.createCommandEncoder(),M={colorAttachments:[{view:t.getCurrentTexture().createView(),loadOp:"clear",clearValue:{r:.5,g:.8,b:1,a:1},storeOp:"store"}],depthStencilAttachment:{view:ie.createView(),depthLoadOp:"clear",depthClearValue:1,depthStoreOp:"store"}},y=c.beginRenderPass(M);y.setPipeline(o),y.setVertexBuffer(0,W),y.setIndexBuffer(i,"uint16"),y.setBindGroup(0,oe),y.setBindGroup(1,ce),y.setBindGroup(2,le),y.drawIndexed(36,B.length,0,0,0),y.end(),e.queue.submit([c.finish()]);const w=performance.now()-g;Le.textContent=`        fps: ${(1/d).toFixed(1)}
        js: ${w.toFixed(1)}ms
        `,requestAnimationFrame(x)}requestAnimationFrame(x)}const Le=document.querySelector("#info"),G=document.querySelector("canvas");if(G===null)throw new Error("Canvas not found");const ze=window.innerWidth,Ce=window.innerHeight;G.width=ze;G.height=Ce;let X;navigator.gpu.requestAdapter().then(e=>{if(X=e,X===null)throw new Error("WebGPU not supported");let t=null;X.requestDevice().then(r=>{t=r;const i=G.getContext("webgpu");if(i===null)throw new Error("WebGPU context not found");i.configure({device:t,format:navigator.gpu.getPreferredCanvasFormat()}),Fe(t,i)})});
