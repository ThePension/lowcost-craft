var de=Object.defineProperty;var ue=(e,t,r)=>t in e?de(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var l=(e,t,r)=>ue(e,typeof t!="symbol"?t+"":t,r);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function r(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(n){if(n.ep)return;n.ep=!0;const s=r(n);fetch(n.href,s)}})();var V=1e-6,O=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});function $(){var e=new O(16);return O!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function pe(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function me(e,t,r){var i=t[0],n=t[1],s=t[2],a=t[3],o=t[4],c=t[5],M=t[6],f=t[7],d=t[8],w=t[9],h=t[10],E=t[11],y=t[12],x=t[13],P=t[14],v=t[15],u=r[0],p=r[1],m=r[2],g=r[3];return e[0]=u*i+p*o+m*d+g*y,e[1]=u*n+p*c+m*w+g*x,e[2]=u*s+p*M+m*h+g*P,e[3]=u*a+p*f+m*E+g*v,u=r[4],p=r[5],m=r[6],g=r[7],e[4]=u*i+p*o+m*d+g*y,e[5]=u*n+p*c+m*w+g*x,e[6]=u*s+p*M+m*h+g*P,e[7]=u*a+p*f+m*E+g*v,u=r[8],p=r[9],m=r[10],g=r[11],e[8]=u*i+p*o+m*d+g*y,e[9]=u*n+p*c+m*w+g*x,e[10]=u*s+p*M+m*h+g*P,e[11]=u*a+p*f+m*E+g*v,u=r[12],p=r[13],m=r[14],g=r[15],e[12]=u*i+p*o+m*d+g*y,e[13]=u*n+p*c+m*w+g*x,e[14]=u*s+p*M+m*h+g*P,e[15]=u*a+p*f+m*E+g*v,e}function ge(e,t,r){var i=r[0],n=r[1],s=r[2],a,o,c,M,f,d,w,h,E,y,x,P;return t===e?(e[12]=t[0]*i+t[4]*n+t[8]*s+t[12],e[13]=t[1]*i+t[5]*n+t[9]*s+t[13],e[14]=t[2]*i+t[6]*n+t[10]*s+t[14],e[15]=t[3]*i+t[7]*n+t[11]*s+t[15]):(a=t[0],o=t[1],c=t[2],M=t[3],f=t[4],d=t[5],w=t[6],h=t[7],E=t[8],y=t[9],x=t[10],P=t[11],e[0]=a,e[1]=o,e[2]=c,e[3]=M,e[4]=f,e[5]=d,e[6]=w,e[7]=h,e[8]=E,e[9]=y,e[10]=x,e[11]=P,e[12]=a*i+f*n+E*s+t[12],e[13]=o*i+d*n+y*s+t[13],e[14]=c*i+w*n+x*s+t[14],e[15]=M*i+h*n+P*s+t[15]),e}function ye(e,t,r){var i=r[0],n=r[1],s=r[2];return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*s,e[9]=t[9]*s,e[10]=t[10]*s,e[11]=t[11]*s,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function we(e,t,r,i,n){var s=1/Math.tan(t/2),a;return e[0]=s/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,n!=null&&n!==1/0?(a=1/(i-n),e[10]=(n+i)*a,e[14]=2*n*i*a):(e[10]=-1,e[14]=-2*i),e}var Me=we;function xe(e,t,r,i){var n,s,a,o,c,M,f,d,w,h,E=t[0],y=t[1],x=t[2],P=i[0],v=i[1],u=i[2],p=r[0],m=r[1],g=r[2];return Math.abs(E-p)<V&&Math.abs(y-m)<V&&Math.abs(x-g)<V?pe(e):(f=E-p,d=y-m,w=x-g,h=1/Math.hypot(f,d,w),f*=h,d*=h,w*=h,n=v*w-u*d,s=u*f-P*w,a=P*d-v*f,h=Math.hypot(n,s,a),h?(h=1/h,n*=h,s*=h,a*=h):(n=0,s=0,a=0),o=d*a-w*s,c=w*n-f*a,M=f*s-d*n,h=Math.hypot(o,c,M),h?(h=1/h,o*=h,c*=h,M*=h):(o=0,c=0,M=0),e[0]=n,e[1]=o,e[2]=f,e[3]=0,e[4]=s,e[5]=c,e[6]=d,e[7]=0,e[8]=a,e[9]=M,e[10]=w,e[11]=0,e[12]=-(n*E+s*y+a*x),e[13]=-(o*E+c*y+M*x),e[14]=-(f*E+d*y+w*x),e[15]=1,e)}function Y(){var e=new O(3);return O!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function Ee(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e}function F(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e}function ee(e,t){var r=t[0],i=t[1],n=t[2],s=r*r+i*i+n*n;return s>0&&(s=1/Math.sqrt(s)),e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e}function Pe(e,t,r){var i=t[0],n=t[1],s=t[2],a=r[0],o=r[1],c=r[2];return e[0]=n*c-s*o,e[1]=s*a-i*c,e[2]=i*o-n*a,e}(function(){var e=Y();return function(t,r,i,n,s,a){var o,c;for(r||(r=3),i||(i=0),n?c=Math.min(n*r+i,t.length):c=t.length,o=i;o<c;o+=r)e[0]=t[o],e[1]=t[o+1],e[2]=t[o+2],s(e,e,a),t[o]=e[0],t[o+1]=e[1],t[o+2]=e[2];return t}})();class T{constructor(t,r,i,n){l(this,"position");l(this,"modelMatrix");l(this,"textureCoords");l(this,"faceMask");this.position=t,this.faceMask=n,this.modelMatrix=$(),ge(this.modelMatrix,this.modelMatrix,t),ye(this.modelMatrix,this.modelMatrix,r),this.textureCoords=i}static calculateFaceMask(t,r,i,n){let s=0;return n.has(`${t+1},${r},${i}`)||(s|=this.FACE_RIGHT),n.has(`${t-1},${r},${i}`)||(s|=this.FACE_LEFT),n.has(`${t},${r+1},${i}`)||(s|=this.FACE_TOP),n.has(`${t},${r-1},${i}`)||(s|=this.FACE_BOTTOM),n.has(`${t},${r},${i+1}`)||(s|=this.FACE_FRONT),n.has(`${t},${r},${i-1}`)||(s|=this.FACE_BACK),s}}l(T,"cubeVertices",new Float32Array([-.5,-.5,.5,0,1,0,0,1,.5,-.5,.5,1,1,0,0,1,.5,.5,.5,1,0,0,0,1,-.5,.5,.5,0,0,0,0,1,-.5,-.5,-.5,0,1,0,0,-1,.5,-.5,-.5,1,1,0,0,-1,.5,.5,-.5,1,0,0,0,-1,-.5,.5,-.5,0,0,0,0,-1,-.5,.5,.5,-2,0,0,1,0,.5,.5,.5,-1,0,0,1,0,.5,.5,-.5,-1,1,0,1,0,-.5,.5,-.5,-2,1,0,1,0,-.5,-.5,.5,0,1,0,-1,0,.5,-.5,.5,1,1,0,-1,0,.5,-.5,-.5,1,0,0,-1,0,-.5,-.5,-.5,0,0,0,-1,0,.5,-.5,.5,0,1,1,0,0,.5,-.5,-.5,1,1,1,0,0,.5,.5,-.5,1,0,1,0,0,.5,.5,.5,0,0,1,0,0,-.5,-.5,.5,1,1,-1,0,0,-.5,-.5,-.5,0,1,-1,0,0,-.5,.5,-.5,0,0,-1,0,0,-.5,.5,.5,1,0,-1,0,0])),l(T,"FACE_FRONT",1),l(T,"FACE_BACK",2),l(T,"FACE_TOP",4),l(T,"FACE_BOTTOM",8),l(T,"FACE_RIGHT",16),l(T,"FACE_LEFT",32),l(T,"cubeIndices",new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]));class Te{constructor(){l(this,"position");l(this,"direction");l(this,"target");l(this,"up");l(this,"cameraSpeed",.5);l(this,"yaw",0);l(this,"pitch",0);l(this,"sensitivity",.002);l(this,"keysPressed",{});this.position=[0,0,0],this.direction=[0,0,0],this.target=[0,0,0],this.up=[0,1,0],window.addEventListener("keydown",t=>{this.keysPressed[t.key]=!0}),window.addEventListener("keyup",t=>{this.keysPressed[t.key]=!1}),document.addEventListener("click",()=>{document.body.requestPointerLock()}),window.addEventListener("mousemove",t=>this.hanbleMouseMoveEvent(t))}hanbleMouseMoveEvent(t){document.pointerLockElement===document.body&&(this.yaw+=t.movementX*this.sensitivity,this.pitch-=t.movementY*this.sensitivity,this.pitch=Math.max(-Math.PI/2,Math.min(Math.PI/2,this.pitch)))}updateCameraDirection(){this.direction=[Math.cos(this.pitch)*Math.cos(this.yaw),Math.sin(this.pitch),Math.cos(this.pitch)*Math.sin(this.yaw)],Ee(this.target,this.position,this.direction)}updateCameraPosition(){const t=Y(),r=Y(),i=[0,1,0];ee(t,this.direction),Pe(r,t,i),ee(r,r),this.keysPressed.w&&F(this.position,this.position,t,this.cameraSpeed),this.keysPressed.s&&F(this.position,this.position,t,-this.cameraSpeed),this.keysPressed.a&&F(this.position,this.position,r,-this.cameraSpeed),this.keysPressed.d&&F(this.position,this.position,r,this.cameraSpeed),this.keysPressed[" "]&&F(this.position,this.position,i,this.cameraSpeed),this.keysPressed.Shift&&F(this.position,this.position,i,-this.cameraSpeed)}}class j{static async loadShaderModuleFromFile(t,r){const n=await(await fetch(r)).text();return t.createShaderModule({code:n})}static async loadAtlasTexture(t,r){const i=await fetch(r),n=await createImageBitmap(await i.blob()),s=t.createTexture({size:[n.width,n.height,1],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});return t.queue.copyExternalImageToTexture({source:n},{texture:s},[n.width,n.height]),s}}const se=Math.sqrt(3),ve=.5*(se-1),_=(3-se)/6,te=e=>Math.floor(e)|0,re=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);function Be(e=Math.random){const t=Se(e),r=new Float64Array(t).map(n=>re[n%12*2]),i=new Float64Array(t).map(n=>re[n%12*2+1]);return function(s,a){let o=0,c=0,M=0;const f=(s+a)*ve,d=te(s+f),w=te(a+f),h=(d+w)*_,E=d-h,y=w-h,x=s-E,P=a-y;let v,u;x>P?(v=1,u=0):(v=0,u=1);const p=x-v+_,m=P-u+_,g=x-1+2*_,q=P-1+2*_,D=d&255,N=w&255;let A=.5-x*x-P*P;if(A>=0){const B=D+t[N],k=r[B],U=i[B];A*=A,o=A*A*(k*x+U*P)}let G=.5-p*p-m*m;if(G>=0){const B=D+v+t[N+u],k=r[B],U=i[B];G*=G,c=G*G*(k*p+U*m)}let C=.5-g*g-q*q;if(C>=0){const B=D+1+t[N+1],k=r[B],U=i[B];C*=C,M=C*C*(k*g+U*q)}return 70*(o+c+M)}}function Se(e){const r=new Uint8Array(512);for(let i=0;i<512/2;i++)r[i]=i;for(let i=0;i<512/2-1;i++){const n=i+~~(e()*(256-i)),s=r[i];r[i]=r[n],r[n]=s}for(let i=256;i<512;i++)r[i]=r[i-256];return r}class ae{constructor(){l(this,"amplitude",20);l(this,"frequency",.01);l(this,"noise2D");this.noise2D=Be()}static get Instance(){return this._instance||(this._instance=new this)}getTerrainHeight(t,r){return Math.floor(this.noise2D(t*this.frequency,r*this.frequency)*this.amplitude)}}l(ae,"_instance");class be{constructor(t,r=16){l(this,"chunk_size",16);l(this,"pos");l(this,"cubes");this.pos=t,this.cubes=new Map,this.chunk_size=r}generateChunk(){for(let t=0;t<this.chunk_size;t++)for(let r=0;r<this.chunk_size;r++){let i=t-this.chunk_size/2+this.pos[0],n=r-this.chunk_size/2+this.pos[1],s=ae.Instance.getTerrainHeight(i,n);for(let a=s;a>-this.chunk_size;a--){const o=[i,a,n];let c;a===s?c=[4,4]:a>s-3?c=[2,0]:c=[1,0];const M=new T(o,[1,1,1],c,0);this.addCube(i,a,n,M)}}}addCube(t,r,i,n){this.cubes.set(`${t},${r},${i}`,n)}getCube(t,r,i){return this.cubes.get(`${t},${r},${i}`)}calculateFaceMasks(t){this.cubes.forEach(r=>{r.faceMask=T.calculateFaceMask(r.position[0],r.position[1],r.position[2],t)})}}const z=new Te,Fe=16*4;let Q,J,X,K,oe,W,ce,Z,he,ie,S,le,fe;const L=16,I=new Map,ne=10*L;function Ae(e,t){const r=Math.floor(e/L),i=Math.floor(t/L);return`${r},${i}`}const R=new Set;for(let e=0;e<ne;e+=L)for(let t=0;t<ne;t+=L){const r=Ae(e,t);if(!I.has(r)){const i=new be([e,t]);i.generateChunk(),I.set(r,i),i.cubes.keys().forEach(n=>{R.add(n)})}}I.forEach(e=>e.calculateFaceMasks(R));function Ge(e){S=new Float32Array(R.size*(4*4+2+1+1)),Q=e.createBuffer({label:"uniformBuffer",size:Fe,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),X=e.createBuffer({label:"vertexBuffer",size:T.cubeVertices.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});let t=0;I.forEach(r=>{r.cubes.forEach(i=>{const n=t*20;S.set(i.modelMatrix,n),S.set(i.textureCoords,n+4*4),S[n+4*4+2]=i.faceMask,t++})}),J=e.createBuffer({label:"instanceBuffer",size:S.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST})}function Ce(e){K=e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform"}}]}),oe=e.createBindGroup({layout:K,entries:[{binding:0,resource:{buffer:Q}}]}),W=e.createBindGroupLayout({entries:[{binding:1,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage",minBindingSize:S.byteLength}}]}),ce=e.createBindGroup({layout:W,entries:[{binding:1,resource:{buffer:J,size:S.byteLength}}]}),Z=e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),he=e.createBindGroup({layout:Z,entries:[{binding:0,resource:le.createView()},{binding:1,resource:fe}]})}async function ke(e,t){Ge(e),le=await j.loadAtlasTexture(e,"basic_atlas.png"),fe=e.createSampler({magFilter:"linear",minFilter:"linear"}),Ce(e),ie=e.createTexture({size:[b.width,b.height],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT});const r=$();Me(r,Math.PI/4,b.width/b.height,.1,500),e.queue.writeBuffer(J,0,S),e.queue.writeBuffer(X,0,T.cubeVertices);const i=e.createBuffer({size:T.cubeIndices.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST});e.queue.writeBuffer(i,0,T.cubeIndices);const n=await j.loadShaderModuleFromFile(e,"shaders/vertex.wgsl"),s=await j.loadShaderModuleFromFile(e,"shaders/fragment.wgsl");function a(){const f=$();xe(f,z.position,z.target,z.up);const d=$();me(d,r,f),e.queue.writeBuffer(Q,0,d)}const o=e.createRenderPipeline({layout:e.createPipelineLayout({bindGroupLayouts:[K,W,Z]}),vertex:{module:n,entryPoint:"vertexMain",buffers:[{arrayStride:8*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x2"},{shaderLocation:2,offset:5*4,format:"float32x3"}]}]},fragment:{module:s,entryPoint:"fragmentMain",targets:[{format:navigator.gpu.getPreferredCanvasFormat()}]},primitive:{topology:"triangle-list",cullMode:"none"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}});let c=0;function M(){z.updateCameraPosition(),z.updateCameraDirection(),a();const f=performance.now()/1e3,d=f-c;c=f;const w=performance.now(),h=e.createCommandEncoder(),E={colorAttachments:[{view:t.getCurrentTexture().createView(),loadOp:"clear",clearValue:{r:.5,g:.8,b:1,a:1},storeOp:"store"}],depthStencilAttachment:{view:ie.createView(),depthLoadOp:"clear",depthClearValue:1,depthStoreOp:"store"}},y=h.beginRenderPass(E);y.setPipeline(o),y.setVertexBuffer(0,X),y.setIndexBuffer(i,"uint16"),y.setBindGroup(0,oe),y.setBindGroup(1,ce),y.setBindGroup(2,he),y.drawIndexed(36,R.size,0,0,0),y.end(),e.queue.submit([h.finish()]);const x=performance.now()-w;Ue.textContent=`        fps: ${(1/d).toFixed(1)}
        js: ${x.toFixed(1)}ms
        `,requestAnimationFrame(M)}requestAnimationFrame(M)}const Ue=document.querySelector("#info"),b=document.querySelector("canvas");if(b===null)throw new Error("Canvas not found");const _e=window.innerWidth,ze=window.innerHeight;b.width=_e;b.height=ze;let H;navigator.gpu.requestAdapter().then(e=>{if(H=e,H===null)throw new Error("WebGPU not supported");let t=null;H.requestDevice().then(r=>{t=r;const i=b.getContext("webgpu");if(i===null)throw new Error("WebGPU context not found");i.configure({device:t,format:navigator.gpu.getPreferredCanvasFormat()}),ke(t,i)})});
